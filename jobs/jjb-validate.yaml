---
- job:
    name: jjb-validate
    project-type: pipeline
    sandbox: true
    concurrent: true
    properties:
      - github:
          url: https://github.com/ceph/ceph-csi
      - build-discarder:
          days-to-keep: 7
          artifact-days-to-keep: 7
    parameters:
      - string:
          name: ghprbPullId
          description: GitHub Pull-Request ID for testing
          default: 0
    dsl: |
      def GIT_REPO = 'https://github.com/ceph/ceph-csi'
      def GIT_BRANCH = 'ci/centos'

      if (params.ghprbPullId != null && "${ghprbPullId}" != "0") {
          GIT_BRANCH = "pull/${ghprbPullId}/head"
      }

      node {
        stage('checkout ci repository') {
          checkout([$class: 'GitSCM', branches: [[name: 'FETCH_HEAD']],
            userRemoteConfigs: [[url: "${GIT_REPO}",
              refspec: "${GIT_BRANCH}"]]])
        }
        stage('validation') {
          sh './deploy/jjb.sh validate'
        }
      }
    triggers:
      - github-pull-request:
          status-context: ci/centos/jjb-validate
          trigger-phrase: '/(re)?test ((all)|(ci/centos/jjb-validate))'
          permit-all: true
          # TODO: set github-hooks to true when it is configured in GitHub
          github-hooks: false
          cron: 'H/5 * * * *'
          white-list-target-branches:
            - ci/centos
          org-list:
            - ceph
          allow-whitelist-orgs-as-admins: true
