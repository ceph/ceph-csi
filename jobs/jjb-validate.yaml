---
- job:
    name: jjb-validate
    project-type: pipeline
    concurrent: false
    properties:
      - github:
          url: https://github.com/ceph/ceph-csi
      - build-discarder:
          days-to-keep: 7
          artifact-days-to-keep: 7
    dsl: |
      def GIT_REPO = 'https://github.com/ceph/ceph-csi'
      def GIT_BRANCH = 'ci/centos'

      if (params.ghprbPullId != null) {
          GIT_BRANCH = "pull/${ghprbPullId}/merge"
      }

      node {
        stage('checkout ci repository') {
          checkout([$class: 'GitSCM', branches: [[name: 'FETCH_HEAD']],
            userRemoteConfigs: [[url: "${GIT_REPO}",
              refspec: "${GIT_BRANCH}"]]])
        }
        stage('validation') {
          sh "GIT_REF=${GIT_BRANCH} ./deploy/jjb.sh validate"
        }
      }
    triggers:
      - github-pull-request:
          status-context: ci/centos/jjb-validate
          trigger-phrase: '/(re)?test ((all)|(ci/centos/jjb-validate))'
          permit-all: true
          github-hooks: true
          white-list-target-branches:
            - ci/centos
          org-list:
            - ceph
          allow-whitelist-orgs-as-admins: true
